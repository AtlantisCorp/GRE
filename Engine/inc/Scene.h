//
//  Scene.h
//  GRE
//
//  Created by Jacques Tronconi on 12/12/2015.
//
//

#ifndef GRE_Scene_h
#define GRE_Scene_h

#include "Mesh.h"
#include "Node.h"
#include "Camera.h"
#include "Pass.h"

GRE_BEGIN_NAMESPACE

//////////////////////////////////////////////////////////////////////
/// @brief A Generic Base Scene object.
///
/// The default implementation does nothing. You should create
/// or use a plugin that register a correct ScenePrivate object,
/// and load it to your Renderer object.
///
/// Pass Management : The Scene object automaticly creates a Default
/// PassPurpose::First Pass object. This Pass normally should only draws
/// every objects in the Scene, according to the active Camera, with a
/// pass-through HardwareProgram. But this behaviour is not guaranteed.
///
//////////////////////////////////////////////////////////////////////
class DLL_PUBLIC ScenePrivate : public Resource
{
    
public:
    
    POOLED(Pools::Resource)
    
    ScenePrivate(const std::string& name);
    virtual ~ScenePrivate();
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the Root node from the node tree.
    /// Dependent of the implementation. The default implementation
    /// returns Node::Null.
    //////////////////////////////////////////////////////////////////////
    virtual Node& getRoot();
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the Root node from the node tree.
    /// Dependent of the implementation. The default implementation
    /// returns Node::Null.
    //////////////////////////////////////////////////////////////////////
    virtual const Node& getRoot() const;
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Creates a new node.
    /// Dependent of the implementation. The default implementation
    /// returns Node::Null.
    /// @param mesh     A Mesh to initialize the Node with.
    //////////////////////////////////////////////////////////////////////
    virtual NodePrivate* createNode(const Mesh& mesh);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Creates a new Node with a camera in it.
    /// The Node will return a Camera with Node::getCamera() and Mesh::Null
    /// with Node::getMesh() if it does not contain any Mesh.
    //////////////////////////////////////////////////////////////////////
    virtual NodePrivate* createNode(const Camera& camera);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Empty the Scene and destroy every Node objects.
    //////////////////////////////////////////////////////////////////////
    virtual void clear();
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the currently active camera.
    //////////////////////////////////////////////////////////////////////
    virtual Camera& getCamera();
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the currently active camera.
    //////////////////////////////////////////////////////////////////////
    virtual const Camera& getCamera() const;
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns a list of the Nodes, sorted by given filter.
    /// @param filter   A filter defined by the Node to sort them.
    /// If the filter given is not implemented, Node::Filter::Default is
    /// used as a fallback generally, but this behaviour can be undefined.
    /// @note By default, not implemented function return an empty vector.
    //////////////////////////////////////////////////////////////////////
    virtual std::vector<const Node> getNodesByFilter(Node::Filter filter) const;
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Sets the active Camera given its Node.
    //////////////////////////////////////////////////////////////////////
    virtual void setActiveCamera(const Node& cameraNode);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Create a Default Pass given its name and number.
    /// If passNumber is already taken, return Pass::Null.
    //////////////////////////////////////////////////////////////////////
    Pass createAndAddPass(const std::string& name, const PassNumber& passNumber);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Adds given custom created pass.
    /// This function takes ownership of the Pointer. Also, it may return
    /// Pass::Null if an error occured.
    //////////////////////////////////////////////////////////////////////
    Pass addPass(PassPrivate* customPass);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the first Pass with given name.
    //////////////////////////////////////////////////////////////////////
    Pass getPassByName(const std::string& name);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the pass at given number.
    //////////////////////////////////////////////////////////////////////
    Pass getPassByNumber(const PassNumber& passNumber);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Removes the first Pass with given name.
    //////////////////////////////////////////////////////////////////////
    void removePassByName(const std::string& name);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Removes the Pass with given number.
    //////////////////////////////////////////////////////////////////////
    void removePassByNumber(const PassNumber& passNumber);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns every active Pass, sorted by PassNumber from first
    /// to last.
    //////////////////////////////////////////////////////////////////////
    PassList getActivePasses() const;
    
protected:
    
    /// @brief Holds every Pass in the Scene.
    PassPrivateOwnedList _mPasses;
    
    /// @brief Catalog to Pass objects by name.
    std::map<PassNumber, std::weak_ptr<PassPrivate> > _mPassesByNumber;
};

//////////////////////////////////////////////////////////////////////
/// @brief A Generic Scene object user.
///
/// Always use this object to access the ScenePrivate Resource. You can
/// obtain an object of this type using the ResourceManager Resource
/// loading system, or using Renderer::loadSceneByName(), which use also
/// the ResourceManager Resource loading system, but also call directly
/// Renderer::loadSceneByResource().
///
//////////////////////////////////////////////////////////////////////
class DLL_PUBLIC Scene : public ResourceUser
{
    
public:
    
    Scene();
    Scene(const Scene& rhs);
    Scene(Scene&& rhs);
    explicit Scene(const ResourceUser& rhs);
    
    ~Scene();
    
    Scene& operator = (const Scene& rhs);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the Root node from the node tree, or Node::Null if
    /// ScenePrivate is not valid.
    //////////////////////////////////////////////////////////////////////
    Node& getRoot();
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the Root node from the node tree, or Node::Null if
    /// ScenePrivate is not valid.
    //////////////////////////////////////////////////////////////////////
    const Node& getRoot() const;
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Creates a new Node, or Node::Null if ScenePrivate is not
    /// valid.
    /// @param mesh     A Mesh to initialize the Node with.
    //////////////////////////////////////////////////////////////////////
    NodePrivate* createNode(const Mesh& mesh);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Creates a new Node with a camera in it.
    //////////////////////////////////////////////////////////////////////
    NodePrivate* createNode(const Camera& camera);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Empty the Scene and destroy every Node objects.
    //////////////////////////////////////////////////////////////////////
    void clear();
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the currently active camera.
    //////////////////////////////////////////////////////////////////////
    Camera& getCamera();
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the currently active camera.
    //////////////////////////////////////////////////////////////////////
    const Camera& getCamera() const;
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns a list of the Nodes.
    /// It is a convenient function to call for ::getNodesByFilter(Node::Filter::Default) .
    //////////////////////////////////////////////////////////////////////
    std::vector<const Node> getNodes() const;
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns a list of the Nodes, sorted by given filter.
    /// @param filter   A filter defined by the Node to sort them.
    /// If the filter given is not implemented, Node::Filter::Default is
    /// used as a fallback generally, but this behaviour can be undefined.
    //////////////////////////////////////////////////////////////////////
    std::vector<const Node> getNodesByFilter(Node::Filter filter) const;
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Sets the active Camera given its Node.
    //////////////////////////////////////////////////////////////////////
    void setActiveCamera(const Node& cameraNode);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Create a Default Pass given its name and number.
    /// If passNumber is already taken, return Pass::Null.
    //////////////////////////////////////////////////////////////////////
    Pass createAndAddPass(const std::string& name, const PassNumber& passNumber);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Adds given custom created pass.
    /// This function takes ownership of the Pointer. Also, it may return
    /// Pass::Null if an error occured.
    //////////////////////////////////////////////////////////////////////
    Pass addPass(PassPrivate* customPass);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the first Pass with given name.
    //////////////////////////////////////////////////////////////////////
    Pass getPassByName(const std::string& name);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns the pass at given number.
    //////////////////////////////////////////////////////////////////////
    Pass getPassByNumber(const PassNumber& passNumber);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Removes the first Pass with given name.
    //////////////////////////////////////////////////////////////////////
    void removePassByName(const std::string& name);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Removes the Pass with given number.
    //////////////////////////////////////////////////////////////////////
    void removePassByNumber(const PassNumber& passNumber);
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns every active Pass, sorted by PassNumber from first
    /// to last.
    //////////////////////////////////////////////////////////////////////
    PassList getActivePasses() const;
    
    /// @brief A Null Scene User.
    static Scene Null;
    
private:
    
    std::weak_ptr<ScenePrivate> _mScene;
};

//////////////////////////////////////////////////////////////////////
/// @brief A basic loader to load Scene Objects.
//////////////////////////////////////////////////////////////////////
class DLL_PUBLIC SceneLoader : public ResourceLoader
{
public:
    
    POOLED(Pools::Loader)
    
    SceneLoader();
    virtual ~SceneLoader();
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Returns true if Resource::Type is ::Scene.
    //////////////////////////////////////////////////////////////////////
    virtual bool isTypeSupported(Resource::Type type) const;
    
    //////////////////////////////////////////////////////////////////////
    /// @brief Loads a scene.
    /// Default implementation returns a null pointer.
    //////////////////////////////////////////////////////////////////////
    virtual Resource* load(Resource::Type type, const std::string& name) const;
    
};

typedef ResourceLoaderFactory<SceneLoader> SceneLoaderFactory;

GRE_END_NAMESPACE

#endif
